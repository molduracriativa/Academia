<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>C√¢mera Customizada - Molduras Est√°ticas</title>

<style>
:root {
    --accent: #25D366;
    --record: #ff0000;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; background: #000; color: #fff; overflow: hidden;
    width: 100vw; height: 100dvh;
    font-family: sans-serif;
}

.frame { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
.stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #111; }

#camera {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    object-fit: cover; 
    transform: scaleX(1); 
    transform-origin: center center;
    background: black; 
    transition: transform 0.3s; 
}
#camera.mirrored { transform: scaleX(-1); }

#canvasPreview, #videoPreview {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    object-fit: contain; background: black;
    display: none; z-index: 6;
}

#molduraImagePreview {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    object-fit: cover; object-position: bottom; pointer-events: none;
    z-index: 5; display: none;
}

#canvasFinal { display: none; }

.ui-layer {
    position: absolute; inset: 0; pointer-events: none; z-index: 20;
    display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
}

.top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }

.timer-badge {
    background: var(--record); padding: 5px 12px; border-radius: 12px;
    font-weight: bold; font-size: 16px; display: none; animation: pulse 1s infinite;
}

@keyframes pulse {
    0%{opacity:1}50%{opacity:.7}100%{opacity:1}
}

.controls-bottom {
    display: flex; flex-direction: column; align-items: center; gap: 30px;
    pointer-events: auto; padding-bottom: 20px;
}

.btn {
    padding: 10px 16px; font-size: 14px; font-weight: 600;
    border: 2px solid rgba(255,255,255,0.3); border-radius: 20px;
    background: rgba(0,0,0,0.65); cursor: pointer; color: #fff;
}

.btn-frame { border-color: var(--accent); }

.frame-selector { display: flex; gap: 10px; }

.capture-controls { display: flex; gap: 20px; align-items: center; }

.action-btn-mini {
    width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff;
    background: rgba(255,255,255,0.2); cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 24px;
}

.action-btn-large {
    width: 80px; height: 80px; border-radius: 50%;
    border: 4px solid #fff; background: rgba(255,255,255,0.2);
    cursor: pointer; display: flex; align-items:center; justify-content:center;
    transition: .2s;
}

.action-btn-large.recording {
    border-color: var(--record);
    background: rgba(255,0,0,.5);
}

.stop-icon {
    display: none; width:30px; height:30px;
    background:red; border-radius:4px;
}

/* üéØ FUNDO CORRIGIDO AQUI */
#startScreen { 
    position: absolute; inset: 0; 
    background-image: url('capa.jpg'); 
    background-size: cover; 
    background-position: center;
    z-index: 50;
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    gap: 20px; text-align: center;
}

#startBtn { 
    padding:18px 32px; font-size:20px; border:none; 
    background:#FF5722; color:#fff; border-radius:50px; 
    cursor:pointer; 
}

#resultUI .actions {
    display:none; flex-direction:column; gap:12px;
    width:100%; max-width:300px; pointer-events:auto;
}

.action-btn { padding:14px; border-radius:12px; border:none; font-size:16px; cursor:pointer; }

.btn-save { background:var(--accent); }
.btn-new { background:#555; }

.flash {
    position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;
    transition:.1s; z-index:10;
}

/* ----- C√çRCULOS LATERAIS ----- */
.circle-panel {
    position: absolute;
    right: 1.2cm;
    top: 50%;
    transform: translateY(-50%);
    display: none;
    flex-direction: column;
    gap: 12px;
    z-index: 40;
    pointer-events: auto;
}

.circle-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 3px solid white;
    background: transparent;
    cursor: pointer;
    transition: .12s ease;
    box-sizing: border-box;
}

.circle-btn.on {
    background: white;
    border-color: white;
}

@media (max-width: 420px) {
    .circle-panel { right: 1cm; gap:10px; }
    .circle-btn { width:28px; height:28px; }
}
</style>
</head>

<body>

<div id="startScreen">
    <button id="startBtn">INICIAR</button>
</div>

<div class="frame">
    <div class="stage">

        <video id="camera" autoplay playsinline></video>

        <img id="molduraImagePreview" src="" />

        <canvas id="canvasPreview"></canvas>
        <video id="videoPreview" playsinline></video>

        <canvas id="canvasFinal"></canvas>

        <div class="flash" id="flash"></div>

    </div>

    <div class="ui-layer">

        <div class="top-bar">
            <div class="timer-badge" id="timerBadge">00:00</div>
        </div>

        <div class="controls-bottom">

            <div class="frame-selector">
                <button class="btn btn-frame" data-frame="moldura1.png">Moldura 1</button>
            </div>

            <div class="capture-controls">
                <div class="action-btn-mini" id="switchModeBtn">üì∏</div>
                <div class="action-btn-large" id="captureBtn">
                    <div class="stop-icon" id="stopIcon"></div>
                </div>
                <div class="action-btn-mini" id="flipBtn">üîÑ</div>
            </div>
        </div>

    </div>
</div>

<div id="resultUI" style="
    position:absolute; inset:0; background:#000; display:none;
    z-index:60; align-items:center; justify-content:center; flex-direction:column; gap:20px;
    text-align:center;
">
    <img id="finalImage" style="max-width:90%; max-height:70%; border-radius:10px; display:none;">
    <video id="finalVideo" style="max-width:90%; max-height:70%; border-radius:10px; display:none;" controls></video>

    <div class="actions">
        <button class="action-btn btn-save" id="saveBtn">Salvar</button>
        <button class="action-btn btn-new" id="newBtn">Nova Foto/V√≠deo</button>
    </div>
</div>

<div class="circle-panel" id="circlePanel">
    <div class="circle-btn" data-id="c1"></div>
    <div class="circle-btn" data-id="c2"></div>
    <div class="circle-btn" data-id="c3"></div>
    <div class="circle-btn" data-id="c4"></div>
    <div class="circle-btn" data-id="c5"></div>
    <div class="circle-btn" data-id="c6"></div>
    <div class="circle-btn" data-id="c7"></div>
</div>
<script>
let stream = null;
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let isVideoMode = false;
let isMirrored = false;

const camera = document.getElementById("camera");
const captureBtn = document.getElementById("captureBtn");
const stopIcon = document.getElementById("stopIcon");
const switchModeBtn = document.getElementById("switchModeBtn");
const flipBtn = document.getElementById("flipBtn");
const canvasPreview = document.getElementById("canvasPreview");
const videoPreview = document.getElementById("videoPreview");
const canvasFinal = document.getElementById("canvasFinal");
const timerBadge = document.getElementById("timerBadge");
const flash = document.getElementById("flash");
const resultUI = document.getElementById("resultUI");
const finalImage = document.getElementById("finalImage");
const finalVideo = document.getElementById("finalVideo");
const saveBtn = document.getElementById("saveBtn");
const newBtn = document.getElementById("newBtn");
const molduraImagePreview = document.getElementById("molduraImagePreview");
const circlePanel = document.getElementById("circlePanel");

let timerInterval = null;
let secondsElapsed = 0;

document.getElementById("startBtn").onclick = async () => {
    document.getElementById("startScreen").style.display = "none";
    await startCamera();
    circlePanel.style.display = "flex";
};

async function startCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: isMirrored ? "user" : "environment" },
        audio: true
    });

    camera.srcObject = stream;
}

flipBtn.onclick = () => {
    isMirrored = !isMirrored;
    camera.classList.toggle("mirrored");
    startCamera();
};

switchModeBtn.onclick = () => {
    isVideoMode = !isVideoMode;
    switchModeBtn.textContent = isVideoMode ? "üé•" : "üì∏";
};

function flashEffect() {
    flash.style.opacity = 1;
    setTimeout(() => flash.style.opacity = 0, 80);
}

captureBtn.onclick = () => {
    if (isVideoMode) {
        if (!isRecording) startVideoRecording();
        else stopVideoRecording();
    } else {
        takePhoto();
    }
};

function takePhoto() {
    flashEffect();

    const ctx = canvasFinal.getContext("2d");
    canvasFinal.width = camera.videoWidth;
    canvasFinal.height = camera.videoHeight;

    ctx.drawImage(camera, 0, 0, canvasFinal.width, canvasFinal.height);

    if (molduraImagePreview.src) {
        ctx.drawImage(molduraImagePreview, 0, 0, canvasFinal.width, canvasFinal.height);
    }

    finalImage.src = canvasFinal.toDataURL("image/png");
    finalImage.style.display = "block";
    finalVideo.style.display = "none";

    showResultUI();
}

function startVideoRecording() {
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm; codecs=vp8,opus" });

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = saveVideo;

    mediaRecorder.start();
    isRecording = true;

    captureBtn.classList.add("recording");
    stopIcon.style.display = "block";
    startTimer();
}

function stopVideoRecording() {
    isRecording = false;
    captureBtn.classList.remove("recording");
    stopIcon.style.display = "none";
    stopTimer();
    mediaRecorder.stop();
}

function saveVideo() {
    const blob = new Blob(recordedChunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);

    finalVideo.src = url;
    finalVideo.style.display = "block";
    finalImage.style.display = "none";

    showResultUI();
}

function startTimer() {
    secondsElapsed = 0;
    timerBadge.style.display = "block";

    timerInterval = setInterval(() => {
        secondsElapsed++;
        let m = String(Math.floor(secondsElapsed / 60)).padStart(2, "0");
        let s = String(secondsElapsed % 60).padStart(2, "0");
        timerBadge.textContent = `${m}:${s}`;
    }, 1000);
}

function stopTimer() {
    timerBadge.style.display = "none";
    clearInterval(timerInterval);
}

function showResultUI() {
    resultUI.style.display = "flex";
    document.querySelector("#resultUI .actions").style.display = "flex";
    circlePanel.style.display = "none";
}

saveBtn.onclick = () => {
    if (finalImage.style.display === "block") {
        const a = document.createElement("a");
        a.href = finalImage.src;
        a.download = "foto.png";
        a.click();
    } else {
        const a = document.createElement("a");
        a.href = finalVideo.src;
        a.download = "video.webm";
        a.click();
    }
};

newBtn.onclick = () => {
    resultUI.style.display = "none";
    circlePanel.style.display = "flex";
    finalImage.style.display = "none";
    finalVideo.style.display = "none";
};

document.querySelectorAll(".btn-frame").forEach(btn => {
    btn.onclick = () => {
        molduraImagePreview.src = btn.dataset.frame;
        molduraImagePreview.style.display = "block";
    };
});

/* ------- C√çRCULOS (LIGAR/DESLIGAR) ------- */
document.querySelectorAll(".circle-btn").forEach(circle => {
    circle.onclick = () => {
        circle.classList.toggle("on");
    };
});
</script>

</body>
</html>
