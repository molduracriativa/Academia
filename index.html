<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Camera + Moldura</title>

<style>
    body {
        margin: 0;
        background: #000;
        overflow: hidden;
    }

    #camera-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }

    video, canvas, img.moldura {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
        width: 100%;
        height: 100%;
    }

    /* --- 7 C√çRCULOS LATERAIS --- */
    #circles-container {
        position: absolute;
        right: 150px;        /* afastado ~5cm */
        top: 50%;
        transform: translateY(-50%);
        display: none;       /* s√≥ aparece na moldura1 */
        z-index: 9999;
    }

    .circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: 3px solid white;
        margin: 12px 0;
        cursor: pointer;
        background: transparent;
        transition: 0.2s;
    }

    .circle.active {
        background: white;
    }

    /* Bot√µes j√° existentes ‚Äî permaneci tudo igual */
    #buttons {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: flex;
        gap: 20px;
    }

    button {
        padding: 14px 20px;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }
</style>
</head>

<body>

<div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <!-- Moldura aplicada -->
    <img id="moldura" class="moldura" src="" />

    <!-- NOVOS: 7 c√≠rculos -->
    <div id="circles-container"></div>

    <!-- Bot√µes existentes -->
    <div id="buttons">
        <button id="fotoBtn">üì∏ Foto</button>
        <button id="videoBtn">üé• Gravar</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Parar</button>
    </div>
</div>

<script>
/* ----------- C√ÇMERA ORIGINAL ----------- */
let stream;
let mediaRecorder;
let chunks = [];

async function iniciarCamera() {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById("video").srcObject = stream;
}
iniciarCamera();

/* ----------- MOLDURA ----------- */
const moldura = document.getElementById("moldura");
moldura.src = "moldura1.png";   // mant√©m como estava

/* ----------- CIRCUITOS LATERAIS ----------- */
const circlesContainer = document.getElementById("circles-container");
const totalCircles = 7;
let circleStates = new Array(totalCircles).fill(false); // estado salvo

function criarCirculos() {
    circlesContainer.innerHTML = "";
    for (let i = 0; i < totalCircles; i++) {
        const c = document.createElement("div");
        c.classList.add("circle");
        if (circleStates[i]) c.classList.add("active");

        c.addEventListener("click", () => {
            circleStates[i] = !circleStates[i];
            c.classList.toggle("active");
        });

        circlesContainer.appendChild(c);
    }
}

/* Mostrar c√≠rculos somente na moldura1 */
function atualizarVisibilidadeCirculos() {
    if (moldura.src.includes("moldura1")) {
        circlesContainer.style.display = "block";
    } else {
        circlesContainer.style.display = "none";
    }
}
criarCirculos();
atualizarVisibilidadeCirculos();

/* ----------- FOTO FINAL ----------- */
document.getElementById("fotoBtn").addEventListener("click", () => {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Aplicar moldura
    const img = new Image();
    img.src = moldura.src;
    img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Desenhar c√≠rculos na foto
        desenharCirculosCanvas(ctx, canvas);

        const link = document.createElement("a");
        link.download = "foto.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    };
});

/* ----------- DESENHAR C√çRCULOS NO CANVAS ----------- */
function desenharCirculosCanvas(ctx, canvas) {
    const baseX = canvas.width - 150; // mesma posi√ß√£o do layout
    const startY = canvas.height / 2 - ((totalCircles * 35 + (totalCircles - 1) * 12) / 2);

    for (let i = 0; i < totalCircles; i++) {
        const y = startY + i * (35 + 12);

        ctx.lineWidth = 6;
        ctx.strokeStyle = "white";
        ctx.beginPath();
        ctx.arc(baseX, y, 18, 0, Math.PI * 2);
        ctx.stroke();

        if (circleStates[i]) {
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(baseX, y, 18, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

/* ----------- V√çDEO ----------- */
document.getElementById("videoBtn").addEventListener("click", () => {
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    mediaRecorder.ondataavailable = e => chunks.push(e.data);

    mediaRecorder.onstop = async () => {
        // Junta v√≠deo original
        const blob = new Blob(chunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        // Aplicar moldura + c√≠rculos em cada frame
        processarVideoFinal(url);
    };

    mediaRecorder.start();
    document.getElementById("stopBtn").disabled = false;
});

document.getElementById("stopBtn").addEventListener("click", () => {
    mediaRecorder.stop();
    document.getElementById("stopBtn").disabled = true;
});

/* ----------- PROCESSAR V√çDEO COM C√çRCULOS ----------- */
async function processarVideoFinal(videoSrc) {
    const video = document.createElement("video");
    video.src = videoSrc;
    await video.play();

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const outputChunks = [];
    const outputStream = canvas.captureStream();
    const recorder = new MediaRecorder(outputStream, { mimeType: "video/webm" });

    recorder.ondataavailable = e => outputChunks.push(e.data);
    recorder.start();

    function frame() {
        if (video.ended) {
            recorder.stop();
            salvarVideoFinal(outputChunks);
            return;
        }

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Moldura
        ctx.drawImage(moldura, 0, 0, canvas.width, canvas.height);

        // C√≠rculos
        desenharCirculosCanvas(ctx, canvas);

        requestAnimationFrame(frame);
    }

    frame();
}

/* ----------- SALVAR V√çDEO ----------- */
function salvarVideoFinal(chunksFinal) {
    const blob = new Blob(chunksFinal, { type: "video/webm" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "video.webm";
    link.click();
}
</script>

</body>
</html>
